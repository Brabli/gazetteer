"use strict";function icon(t){var e,o,a;return t?(e="fa-city",o="star",a="#8a0303"):(e="fa-building",o="circle",a="rgb(0,55,92)"),L.ExtraMarkers.icon({icon:e,iconColor:"#f0f8ff",svg:!0,markerColor:a,shape:o,prefix:"fa"})}function correctLongitude(t){for(180===Math.abs(t)&&(t+=1e-9);t>180;)t-=360;for(;t<-180;)t+=360;return t}function teleport(t){var e=t.getCenter();Math.abs(e.lng)>=180&&(e.lng=correctLongitude(e.lng),t.setView(e,t.getZoom()))}function removeLayers(t){t.eachLayer(function(e){e._url||t.removeLayer(e)})}async function populateSelect(){for(var t=$("#country-select"),e=await fetch("php/getCountryOptions.php"),o=await e.json(),a=0,n=Object.entries(o);a<n.length;a++){var r=n[a],i=r[0],s=r[1];t.append('<option value="'+s+'">'+i+"</option>")}}async function fetchCountry(t){var e;if(t.latlng&&void 0!==t){var o=t.latlng.lat,a=correctLongitude(t.latlng.lng);e=await fetch("php/getCountry.php?lat="+o+"&long="+a)}else e=await fetch("php/getCountry.php?code="+t);var n=await e.json();return n}async function fetchGeojson(t){var e=localStorage.getItem(t);if(e)return JSON.parse(e);var o=await fetch("php/getGeojson.php?iso3="+t),a=await o.json(),n=JSON.stringify(a);try{localStorage.setItem(t,n)}catch(t){console.log(t)}return a}function addGeojsonToMap(t,e){var o=L.geoJson(t,{style:{color:"rgb(9, 23, 50)",opacity:"0.7",weight:"2",fillColor:"rgba(3,70,118,1)"}});o.addTo(e);var a=t.features[0].properties.cca2;switch(a){case"us":e.setView([40,-118],2);break;case"ru":e.setView([60,80],2);break;case"nz":e.setView([-42,173],5);break;case"fj":e.setView([-17.5,178.5],7);break;default:e.fitBounds(o.getBounds())}}async function getCountryInfo(t){try{var e=await fetch("php/getCountryInfo.php?iso2="+t.iso2),o=await e.json(),a=o.region,n=o.population,r=o.flag,i=o.capital,s=o.latlng,l=o.currencies,c=o.languages,p=l[0],g=p.name,u=p.symbol,d=parseFloat(s[0].toFixed(4))+"°",h=parseFloat(s[1].toFixed(4))+"°";$("#info-country").html(t.countryName+'<img id="info-flag" src='+r+" />"),$("#info-cont").html(a),$("#info-pop").html(n.toLocaleString()),$("#info-cap").html(i),$("#info-coords").html(d+", "+h),$("#currency-name").html(g),$("#currency-symbol").html(u?"( "+u+" )":""),$("#info-lan").html(c[0].name),$("#info-link").html('<a href="'+t.wikiLink+'" target="_blank">Open Wikipedia page in new tab</a>')}catch(t){console.log(t),$("#info-country").html("Something went wrong, sorry!"),$(".country-info-table td").html("")}}async function addCityMarkers(t,e,o){var a,n=sessionStorage.getItem("cities_"+t);if(n)a=JSON.parse(n);else{var r=await fetch("php/getCityInfo.php?iso2="+t);a=await r.json();try{sessionStorage.setItem("cities_"+t,JSON.stringify(a))}catch(t){console.log(t)}}await Promise.all(a.map(async function(t){var a;if(a=sessionStorage.getItem(t.country+"_"+t.name+"_weather"),a)a=JSON.parse(a);else try{var n=await fetch("php/getCityWeather.php?city="+t.name);a=await n.json(),sessionStorage.setItem(t.country+"_"+t.name+"_weather",JSON.stringify(a))}catch(t){console.log(t)}if("ok"!==a.status)return!1;var r=L.marker([t.lat,t.long],{icon:icon(t.isCapital)}).bindPopup('\n      \n      <div class="city-popup" id="'+t.name+'">\n        <h2 class="city-name big-text-shadow">'+t.name+(t.isCapital?' <span class="star">&#9733;</span>':"")+'</h2>\n        <div class="center">\n          <h4 class="city-country-name text-shadow">'+t.country+'</h4>\n          <span class="flag">'+e+'</span>\n        </div>\n    \n        <table class="quick-info-table">\n          <tr>\n            <th>Population:</th>\n            <td>'+t.population.toLocaleString()+"</td>\n          </tr>\n          <tr>\n            <th>Latitude:</th>\n            <td>"+t.lat+'°</td>\n          </tr>\n          <tr id="quick-longitude">\n            <th>Longitude:</th>\n            <td>'+t.long+'°</td>\n          </tr>\n        </table>\n      \n        <h4 class="weather-title text-shadow">Local Weather</h4>\n        <table class="weather-table">\n          <tr>\n            <th>Condition:</th>\n            <td>'+a.condition+"</td>\n          </tr>\n          <tr>\n            <th>Cloud Cover:</th>\n            <td>"+a.cloudCover+"%</td>\n          </tr>  \n          <tr>\n            <th>Temperature:</th>\n            <td>"+a.temp+"&#8451;</td>\n          </tr>\n          <tr>\n            <th>Humidity:</th>\n            <td>"+a.humidity+'%</td>\n          </tr>\n          <tr id="windspeed">\n            <th>Wind Speed:</th>\n            <td>'+a.windSpeed+"mph<br>"+a.windStatement+"</td>\n        </tr>      \n        </table>\n      </div>\n      ",{autoPan:!0,autoPanPadding:[65,65]});r.addTo(o),setTimeout(function(){r.on("mouseover",function(t){r.openPopup()})},200),r.on("click",function(){var t=r.isPopupOpen();t?r.closePopup():r.openPopup()})}))}async function getCountryImages(t){for(var e=await fetch("php/getCountryImages.php?country="+t),o=await e.json(),a=o.hits,n="",r=0;r<a.length;r++){var i='<img class="circle-image" src="'+a[r].previewURL+'" data-image-url="'+a[r].largeImageURL+'" />';n+=i}$(".image-container").html(n),$(".circle-image").on("click",function(t){var e=$(t.currentTarget).attr("data-image-url");$(".big-image").html("<img src="+e+" />"),$(".big-image-container").show(),$(".black-screen").show(),$(".close-button").show()})}async function selectCountry(t){if(!loading){loading=!0,$(".loader").toggle();try{removeLayers(map);var e=await fetchCountry(t);if("ok"===e.message){var o=e.data,a=o.iso3,n=o.iso2,r=o.flag,i=o.countryName;getCountryInfo(e.data),getCountryImages(i),addCityMarkers(n,r,map);var s=await fetchGeojson(a);teleport(map),addGeojsonToMap(s,map)}else console.log(e.message)}catch(t){console.log(t)}$(".loader").toggle(),loading=!1}}function selectUserCountryOnLoad(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(onSuccess,onError,{timeout:1e4})}function onSuccess(t){var e=t.coords.latitude,o=t.coords.longitude;selectCountry({latlng:{lat:e,lng:o}})}function onError(t){console.log(t)}var basemaps={World:L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"}),Roads:L.tileLayer("https://tiles.stadiamaps.com/tiles/outdoors/{z}/{x}/{y}{r}.png",{maxZoom:20,attribution:'&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'}),Terrain:L.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.{ext}",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',subdomains:"abcd",minZoom:0,maxZoom:18,ext:"png"}),Topological:L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'}),"James Bond":L.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}{r}.{ext}",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',subdomains:"abcd",minZoom:0,maxZoom:20,ext:"png"})},overlays={Temperature:L.tileLayer("php/getOverlayTiles.php?z={z}&x={x}&y={y}&tiles=temp_new"),Clouds:L.tileLayer("php/getOverlayTiles.php?z={z}&x={x}&y={y}&tiles=clouds_new"),Precipitation:L.tileLayer("php/getOverlayTiles.php?z={z}&x={x}&y={y}&tiles=precipitation_new"),"Wind Speed":L.tileLayer("php/getOverlayTiles.php?z={z}&x={x}&y={y}&tiles=wind_new"),"Sea Level Pressure":L.tileLayer("php/getOverlayTiles.php?z={z}&x={x}&y={y}&tiles=pressure_new")},loading=!1,hackedSphericalMercator=L.Util.extend(L.Projection.SphericalMercator,{MAX_LATITUDE:89.999}),hackedEPSG3857=L.Util.extend(L.CRS.EPSG3857,{projection:hackedSphericalMercator}),map=L.map("map",{crs:hackedEPSG3857,maxBounds:[[-85,-1/0],[85,1/0]],maxZoom:17,minZoom:1.5,maxBoundsViscosity:1,renderer:L.canvas({padding:.5}),attributionControl:!1,zoomControl:!1}).fitWorld();basemaps.World.addTo(map);var layerControl=L.control.layers(basemaps,overlays,{collapsed:!0}),scaleControlKm=L.control.scale({position:"bottomright",maxWidth:100,metric:!1}),flyToLocationControl=L.easyButton("fa-bullseye",function(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(t){teleport(map),map.flyTo(new L.LatLng(t.coords.latitude,t.coords.longitude),16)})},"Fly to Current Location",{position:"topleft"}),centreMapControl=L.easyButton("fa-expand",function(){teleport(map),map.flyTo(new L.LatLng(45,-5),2)},"Centre Map",{position:"topleft"}),attControl=L.control.attribution({prefix:"",position:"bottomright"});attControl.addTo(map),layerControl.addTo(map),scaleControlKm.addTo(map),flyToLocationControl.addTo(map),centreMapControl.addTo(map),$(".leaflet-control-layers-base").prepend('<a class="leaflet-popup-close-button" id="layer-control-close-button" href="#close">×</a>'),$("#layer-control-close-button").on("click",function(){layerControl.collapse()}),selectUserCountryOnLoad(),populateSelect(),$(".close-button").hide(),map.on("click",async function(t){selectCountry(t)}),$("#country-select").on("change",async function(){var t=$("#country-select option:selected").val();"default"!==t&&selectCountry(t)}),$("#tab").on("click",function(){$(".content").slideToggle({duration:250}),$("#arrow").toggleClass("flip")}),$(".circle-image").on("click",function(t){var e=$(t.currentTarget).attr("src");$(".big-image").html("<img src="+e+" />"),$(".big-image-container").show(),$(".black-screen").show(),$(".close-button").show()}),$(".close-button").on("click",function(){$(".big-image-container").hide(),$(".black-screen").hide()}),window.addEventListener("unload",function(){localStorage.clear()});