"use strict";function icon(t){return new L.Icon({iconUrl:"img/marker-icon-2x-"+t+".png",shadowUrl:"img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]})}function correctLongitude(t){for(180===Math.abs(t)&&(t+=1e-9);t>180;)t-=360;for(;t<-180;)t+=360;return t}function teleport(t){var e=t.getCenter();Math.abs(e.lng)>=180&&(e.lng=correctLongitude(e.lng),t.setView(e,t.getZoom()))}function removeLayers(t){t.eachLayer(function(e){e._url||t.removeLayer(e)})}async function populateSelect(){for(var t=$("#country-select"),e=await fetch("php/getCountryOptions.php"),o=await e.json(),a=0,n=Object.entries(o);a<n.length;a++){var r=n[a],i=r[0],l=r[1];t.append('<option value="'+i+'">'+l+"</option>")}}async function fetchCountry(t,e){var o;if(void 0===e&&(e=void 0),e)o=await fetch("php/getCountry.php?code="+e);else{var a=t.latlng.lat,n=correctLongitude(t.latlng.lng);o=await fetch("php/getCountry.php?lat="+a+"&long="+n)}var r=await o.json();return r}async function fetchGeojson(t){var e=localStorage.getItem(t);if(e)return JSON.parse(e);var o=await fetch("php/getGeojson.php?iso3="+t),a=await o.json(),n=JSON.stringify(a);try{localStorage.setItem(t,n)}catch(t){console.log(t)}return a}function addGeojsonToMap(t,e){var o=L.geoJson(t);o.addTo(e),e.fitBounds(o.getBounds())}async function getCountryInfo(t){try{var e=await fetch("php/getCountryInfo.php?iso2="+t.iso2),o=await e.json(),a=o.region,n=o.population,r=o.flag,i=o.capital,l=o.latlng,s=o.currencies,p=o.languages,c=s[0],d=c.name,h=c.symbol,m=parseFloat(l[0].toFixed(4))+"°",g=parseFloat(l[1].toFixed(4))+"°";$("#info-country").html(t.countryName+'<img id="info-flag" src='+r+" />"),$("#info-cont").html(a),$("#info-pop").html(n.toLocaleString()),$("#info-cap").html(i),$("#info-coords").html(m+", "+g),$("#currency-name").html(d),$("#currency-symbol").html(h?"( "+h+" )":""),$("#info-lan").html(p[0].name),$("#info-link").html('<a href="'+t.wikiLink+'" target="_blank">Open Wikipedia page in new tab</a>')}catch(t){console.log(t),$("#info-country").html("Something went wrong, sorry!"),$(".country-info-table td").html("")}}async function addCityMarkers(t,e,o){var a,n=sessionStorage.getItem("cities_"+t);if(n)a=JSON.parse(n);else{var r=await fetch("php/getCityInfo.php?iso2="+t);a=await r.json();try{sessionStorage.setItem("cities_"+t,JSON.stringify(a))}catch(t){console.log(t)}}await Promise.all(a.map(async function(t){var a;if(a=sessionStorage.getItem(t.country+"_"+t.name+"_weather"),a)a=JSON.parse(a);else try{var n=await fetch("php/getCityWeather.php?city="+t.name);a=await n.json(),sessionStorage.setItem(t.country+"_"+t.name+"_weather",JSON.stringify(a))}catch(t){console.log(t)}if("ok"!==a.status)return!1;var r=L.marker([t.lat,t.long],{icon:t.isCapital?icon("red"):icon("blue")}).bindPopup('\n    <div class="city-popup" id="'+t.name+'">\n      <h2 class="city-name">'+t.name+(t.isCapital?" &#9733;":"")+'</h2>\n      <div class="center">\n        <h4 class="city-country-name">'+t.country+'</h4>\n        <span class="flag">'+e+'</span>\n      </div>\n      <hr />\n      <table class="quick-info-table">\n        <tr>\n          <th>Population:</th>\n          <td>'+t.population.toLocaleString()+"</td>\n        </tr>\n        <tr>\n          <th>Latitude:</th>\n          <td>"+t.lat+"</td>\n        </tr>\n        <tr>\n          <th>Longitude:</th>\n          <td>"+t.long+'</td>\n        </tr>\n      </table>\n      <hr />\n      <h4 class="weather-title">Local Weather</h4>\n      <table class="weather-table">\n        <tr>\n          <th>Condition:</th>\n          <td>'+a.condition+"</td>\n        </tr>\n        <tr>\n          <th>Cloud Cover:</th>\n          <td>"+a.cloudCover+"%</td>\n        </tr>  \n        <tr>\n          <th>Temperature:</th>\n          <td>"+a.temp+"&#8451;</td>\n        </tr>\n        <tr>\n          <th>Humidity:</th>\n          <td>"+a.humidity+"%</td>\n        </tr>\n        <tr>\n          <th>Wind Speed:</th>\n          <td>"+a.windSpeed+"mph - "+a.windStatement+"</td>\n      </tr>      \n      </table>\n    </div>\n    ");r.addTo(o)}))}var basemaps={World:L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"}),Roads:L.tileLayer("https://tiles.stadiamaps.com/tiles/outdoors/{z}/{x}/{y}{r}.png",{maxZoom:20,attribution:'&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'}),Terrain:L.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.{ext}",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',subdomains:"abcd",minZoom:0,maxZoom:18,ext:"png"}),Topological:L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'}),"James Bond":L.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}{r}.{ext}",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',subdomains:"abcd",minZoom:0,maxZoom:20,ext:"png"})},overlays={Temperature:L.tileLayer("php/getOverlayTiles.php?z={z}&x={x}&y={y}&tiles=temp_new"),Clouds:L.tileLayer("php/getOverlayTiles.php?z={z}&x={x}&y={y}&tiles=clouds_new"),Precipitation:L.tileLayer("php/getOverlayTiles.php?z={z}&x={x}&y={y}&tiles=precipitation_new"),"Wind Speed":L.tileLayer("php/getOverlayTiles.php?z={z}&x={x}&y={y}&tiles=wind_new"),"Sea Level Pressure":L.tileLayer("php/getOverlayTiles.php?z={z}&x={x}&y={y}&tiles=pressure_new")},hackedSphericalMercator=L.Util.extend(L.Projection.SphericalMercator,{MAX_LATITUDE:89.999}),hackedEPSG3857=L.Util.extend(L.CRS.EPSG3857,{projection:hackedSphericalMercator}),map=L.map("map",{crs:hackedEPSG3857,maxBounds:[[-85,-1/0],[85,1/0]],maxZoom:17,minZoom:1.5,maxBoundsViscosity:1,attributionControl:!1,zoomControl:!1}).fitWorld();basemaps.World.addTo(map);var layerControl=L.control.layers(basemaps,overlays,{collapsed:!0}),scaleControl=L.control.scale({position:"topleft",maxWidth:100}),flyToLocationControl=L.easyButton("fa-bullseye",function(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(t){teleport(map),map.flyTo(new L.LatLng(t.coords.latitude,t.coords.longitude),16)})},"Fly to Current Location",{position:"topright"}),centreMapControl=L.easyButton("fa-expand",function(){teleport(map),map.flyTo(new L.LatLng(45,-5),2)},"Centre Map",{position:"topright"}),attributionToggleControl=L.easyButton("fa-quote-left",function(){function t(){$("#modal-box").toggle(),e?o.addTo(map):o.remove(map),e=!e,a++,20===a&&(o=L.control.attribution({prefix:"Pre-order Crescent Moon: The Game today for exclusive DLC, artwork and more!"}))}var e=!0,o=L.control.attribution({prefix:""}),a=0;return t}(),"Toggle Attributions",{position:"topright"});layerControl.addTo(map),scaleControl.addTo(map),flyToLocationControl.addTo(map),centreMapControl.addTo(map),attributionToggleControl.addTo(map),$(".leaflet-control-layers-base").prepend('<a class="leaflet-popup-close-button" id="layer-control-close-button" href="#close">×</a>'),$("#layer-control-close-button").on("click",function(){layerControl.collapse()}),populateSelect();var loading=!1;map.on("click",async function(t){if(!loading){loading=!0,$(".loader").toggle();try{removeLayers(map);var e=await fetchCountry(t);if("ok"!==e.message)console.log(e.message);else{var o=await fetchGeojson(e.data.iso3);teleport(map),addGeojsonToMap(o,map),await getCountryInfo(e.data),await addCityMarkers(e.data.iso2,e.data.flag,map)}}catch(t){console.log(t)}$(".loader").toggle(),loading=!1}}),$("#country-select").on("change",async function(){var t=$("#country-select option:selected").val();if("default"!==t&&!loading){loading=!0,$(".loader").toggle();try{removeLayers(map);var e=await fetchCountry(null,t);if("ok"!==e.message)console.log(e.message);else{var o=await fetchGeojson(e.data.iso3);teleport(map),addGeojsonToMap(o,map),await getCountryInfo(e.data),await addCityMarkers(e.data.iso2,e.data.flag,map)}}catch(t){console.log(t)}$(".loader").toggle(),loading=!1}}),$("#tab").on("click",function(){$(".content").slideToggle({duration:250}),$("#arrow").toggleClass("flip")}),window.addEventListener("unload",function(){localStorage.clear()});